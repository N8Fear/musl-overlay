From 23aaa1fd0c5ee1bf95290b6aeda5a67558f6cb5f Mon Sep 17 00:00:00 2001
From: "Anthony G. Basile" <blueness@gentoo.org>
Date: Mon, 29 Jul 2013 12:30:33 +0000
Subject: [PATCH] Make eudev compatible with musl

---
 src/ata_id/ata_id.c     |    1 -
 src/libudev/path-util.c |    2 +-
 src/libudev/strbuf.c    |    2 ++
 src/udev/mkdir.c        |    2 +-
 src/udev/udevadm-hwdb.c |    9 ++++++---
 src/udev/udevd.c        |    9 +--------
 6 files changed, 11 insertions(+), 14 deletions(-)

diff --git a/src/ata_id/ata_id.c b/src/ata_id/ata_id.c
index 68a06b9..595456d 100644
--- a/src/ata_id/ata_id.c
+++ b/src/ata_id/ata_id.c
@@ -30,7 +30,6 @@
 #include <getopt.h>
 #include <scsi/scsi.h>
 #include <scsi/sg.h>
-#include <scsi/scsi_ioctl.h>
 #include <sys/ioctl.h>
 #include <sys/types.h>
 #include <sys/stat.h>
diff --git a/src/libudev/path-util.c b/src/libudev/path-util.c
index fd67310..87f47a5 100644
--- a/src/libudev/path-util.c
+++ b/src/libudev/path-util.c
@@ -152,7 +152,7 @@ char **path_strv_canonicalize(char **l) {
                 }

                 errno = 0;
-                u = canonicalize_file_name(t);
+                u = realpath(t, NULL);
                 if (!u) {
                         if (errno == ENOENT)
                                 u = t;
diff --git a/src/libudev/strbuf.c b/src/libudev/strbuf.c
index 01a076c..9792fed 100644
--- a/src/libudev/strbuf.c
+++ b/src/libudev/strbuf.c
@@ -125,6 +125,8 @@ static void bubbleinsert(struct strbuf_node *node,
         node->children_count ++;
 }

+typedef  int (*__compar_fn_t)(const void *, const void *);
+
 /* add string, return the index/offset into the buffer */
 ssize_t strbuf_add_string(struct strbuf *str, const char *s, size_t len) {
         uint8_t c;
diff --git a/src/udev/mkdir.c b/src/udev/mkdir.c
index 420a9eb..5576fbc 100644
--- a/src/udev/mkdir.c
+++ b/src/udev/mkdir.c
@@ -90,7 +90,7 @@ static int mkdir_parents_internal(const char *prefix, const char *path, mode_t m
         if (e == path)
                 return 0;

-        p = strndupa(path, e - path);
+        p = strndup(path, e - path);
         r = is_dir(p);
         if (r > 0)
                 return 0;
diff --git a/src/udev/udevadm-hwdb.c b/src/udev/udevadm-hwdb.c
index 8f5b1cb..d68dce9 100644
--- a/src/udev/udevadm-hwdb.c
+++ b/src/udev/udevadm-hwdb.c
@@ -123,10 +123,12 @@ static void trie_node_cleanup(struct trie_node *node) {
         free(node);
 }

-static int trie_values_cmp(const void *v1, const void *v2, void *arg) {
+
+static __thread void* cmp_data;
+static int trie_values_cmp(const void *v1, const void *v2) {
         const struct trie_value_entry *val1 = v1;
         const struct trie_value_entry *val2 = v2;
-        struct trie *trie = arg;
+        struct trie *trie = cmp_data;

         return strcmp(trie->strings->buf + val1->key_off,
                       trie->strings->buf + val2->key_off);
@@ -167,7 +169,8 @@ static int trie_node_add_value(struct trie *trie, struct trie_node *node,
         node->values[node->values_count].key_off = k;
         node->values[node->values_count].value_off = v;
         node->values_count++;
-        qsort_r(node->values, node->values_count, sizeof(struct trie_value_entry), trie_values_cmp, trie);
+        cmp_data = trie ;
+        qsort(node->values, node->values_count, sizeof(struct trie_value_entry), trie_values_cmp);
         return 0;
 }

diff --git a/src/udev/udevd.c b/src/udev/udevd.c
index a923ce7..7dc9f03 100644
--- a/src/udev/udevd.c
+++ b/src/udev/udevd.c
@@ -1214,15 +1214,8 @@ int main(int argc, char *argv[])
                 goto exit;
         }

-        if (children_max <= 0) {
-                cpu_set_t cpu_set;
-
+        if (children_max <= 0)
                 children_max = 8;
-
-                if (sched_getaffinity(0, sizeof (cpu_set), &cpu_set) == 0) {
-                        children_max +=  CPU_COUNT(&cpu_set) * 2;
-                }
-        }
         log_debug("set children_max to %u\n", children_max);

         udev_rules_apply_static_dev_perms(rules);
--
1.7.8.6

